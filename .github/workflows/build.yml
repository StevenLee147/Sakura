name: Build

on:
  push:
    branches: [ main, develop ]
    tags:     [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── 构建矩阵（Debug + Release） ────────────────────────────────────────────
  build:
    name: ${{ matrix.config.name }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Windows Debug (MSVC x64)"
            configure_preset: "debug"
            build_preset:     "debug"
            artifact_suffix:  "debug"

          - name: "Windows Release (MSVC x64)"
            configure_preset: "release"
            build_preset:     "release"
            artifact_suffix:  "release"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'ffc071e0c08432c60c9b64f00334c0227667931b'
          vcpkgJsonGlob: 'vcpkg.json'

      - name: Configure CMake (${{ matrix.config.configure_preset }})
        uses: lukka/run-cmake@v10
        with:
          configurePreset: ${{ matrix.config.configure_preset }}

      - name: Build (${{ matrix.config.build_preset }})
        uses: lukka/run-cmake@v10
        with:
          buildPreset: ${{ matrix.config.build_preset }}

      - name: Gather artifacts
        shell: pwsh
        run: |
          $preset   = "${{ matrix.config.artifact_suffix }}"
          $config   = if ($preset -eq "debug") { "Debug" } else { "Release" }
          $outDir   = "artifacts/$preset"
          $buildDir = "build/$preset/$config"

          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $exePath = "$buildDir/Sakura.exe"
          if (Test-Path $exePath) {
            Copy-Item $exePath $outDir
          } else {
            Get-ChildItem -Recurse "build/$preset" -Filter "*.exe" | ForEach-Object {
              Copy-Item $_.FullName $outDir
            }
          }

          $vcpkgBin = "build/$preset/vcpkg_installed/x64-windows/bin"
          if (Test-Path $vcpkgBin) {
            Copy-Item "$vcpkgBin/*.dll" $outDir -ErrorAction SilentlyContinue
          }
          if ($preset -eq "debug") {
            $dbgBin = "build/$preset/vcpkg_installed/x64-windows/debug/bin"
            if (Test-Path $dbgBin) {
              Copy-Item "$dbgBin/*.dll" $outDir -ErrorAction SilentlyContinue
            }
          }
          if (Test-Path "resources") {
            Copy-Item "resources" "$outDir/resources" -Recurse -ErrorAction SilentlyContinue
          }

          # 打包成 zip（供 Release job 使用）
          if ($preset -eq "release") {
            Compress-Archive -Path "$outDir/*" -DestinationPath "artifacts/Sakura-win64.zip" -Force
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sakura-${{ matrix.config.artifact_suffix }}-${{ github.sha }}
          path: artifacts/${{ matrix.config.artifact_suffix }}/
          retention-days: 14
          if-no-files-found: warn

      - name: Upload release zip
        if: matrix.config.artifact_suffix == 'release' && startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-zip
          path: artifacts/Sakura-win64.zip
          retention-days: 1

      - name: Build summary
        if: always()
        shell: pwsh
        run: |
          $preset  = "${{ matrix.config.artifact_suffix }}"
          $config  = if ($preset -eq "debug") { "Debug" } else { "Release" }
          $exePath = "build/$preset/$config/Sakura.exe"
          $exists  = Test-Path $exePath
          $status  = if ($exists) { ":white_check_mark: Build succeeded" } else { ":x: Build failed" }
          $md = "### $status`n| Property | Value |`n|----------|-------|`n| Preset | ``$preset`` |`n| Commit | ``${{ github.sha }}`` |"
          Add-Content $env:GITHUB_STEP_SUMMARY $md

  # ── GitHub Release（仅限 tag push） ────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download release zip
        uses: actions/download-artifact@v4
        with:
          name: release-zip
          path: dist/

      - name: Rename zip with tag version
        run: |
          TAG="${{ github.ref_name }}"
          mv dist/Sakura-win64.zip "dist/Sakura-${TAG}-win64.zip"
          echo "RELEASE_FILE=dist/Sakura-${TAG}-win64.zip" >> $GITHUB_ENV

      - name: Determine pre-release flag
        run: |
          TAG="${{ github.ref_name }}"
          if [[ "$TAG" == *"-dev"* || "$TAG" == *"-alpha"* || "$TAG" == *"-beta"* ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.RELEASE_FILE }}
          prerelease: ${{ env.IS_PRERELEASE }}
          generate_release_notes: true
          name: "Sakura-樱 ${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
