# Sakura-樱 开发路线图

> 最后更新：2026年2月25日

## 项目概况

| 项目 | 说明 |
|------|------|
| **名称** | Sakura-樱 |
| **类型** | 混合模式音乐节奏游戏 |
| **技术栈** | C++ / SDL2 / MinGW / nlohmann-json |
| **目标平台** | Windows |
| **发布渠道** | GitHub 开源发布 + 自建网站/社区 |
| **开发模式** | 个人兴趣项目，持续迭代 |
| **美术风格** | 日系动漫风格 + 樱花核心视觉主题 |
| **目标受众** | 全年龄层音乐爱好者 |

---

## 版本规划总览

```
v0.1 Demo ──→ v0.2 Alpha ──→ v0.3 Beta ──→ v0.5 Early Access ──→ v1.0 正式版
  ↓               ↓               ↓               ↓                    ↓
核心玩法修复   编辑器重做     视觉&音频     社区&在线功能       完整发布
  + 基础可玩    + 计分完善     + 内容制作    + 账户&排行榜       + 全功能
```

---

## Phase 0 — 紧急修复 (v0.1 Demo 前置)

> **目标：** 让现有功能正常工作，产出一个"能玩"的版本

### 0.1 关键 Bug 修复
- [x] **修复谱面编辑器** — 修复了 `charts/` 目录自动创建、工具栏 TAP/HOLD/DRAG 音符类型按钮点击、播放/暂停按钮点击交互，以及播放时的音乐定位（`Mix_SetMusicPosition`）
- [x] **修复游戏暂停逻辑** — 暂停前调用 `Mix_PauseMusic()`，恢复后调用 `Mix_ResumeMusic()`，并使用精确的 `pauseEnterTicks` 补偿，保证时间轴与音频完全同步；同时新增游戏进入时的音乐自动加载与播放
- [x] **实现结算界面** — `Scene_Score()` 已完整实现：显示评级（SS/S/A/B/C/D）、总分、准确率、最大连击、各判定数量（Perfect/Good/Bad/Miss）、Full Combo / All Perfect 标记；通过全局 `g_gameResult` 结构体从游戏场景传递数据，游戏结束（全部音符判定完毕）后自动等待 2 秒跳转结算界面

### 0.2 基础体验保障
- [ ] 确保所有场景切换动画正常工作
- [ ] 确保至少有 2-3 首可完整游玩的测试谱面（含实际音乐文件）
- [ ] 基础的错误处理和崩溃保护

---

## Phase 1 — 核心玩法完善 (v0.2 Alpha)

> **目标：** 建立完整且有深度的游戏机制 ⭐ **最高优先级**

### 1.1 判定系统升级
- [ ] 从当前 4 级（Perfect/Good/Bad/Miss）扩展为 5 级判定
  - **Perfect** (±25ms) — 精准命中
  - **Great** (±50ms) — 优秀命中
  - **Good** (±80ms) — 一般命中
  - **Bad** (±120ms) — 较差命中
  - **Miss** (>150ms 或未命中) — 未命中
- [ ] 每种判定配套不同的视觉特效和音效反馈
- [ ] 支持自定义判定窗口（设置界面中可调节）

### 1.2 Hold（长押）音符完善
- [ ] 完善键盘轨道长押音符的按住判定逻辑（按下→持续→释放三段判定）
- [ ] 长押音符的视觉表现优化（连接带、长条渐变、按住时发光反馈）
- [ ] 长押中途松手的判定处理（部分命中计分、Break特效）
- [ ] 鼠标端长押音符（按住目标）的同步实现

### 1.3 计分系统重做
- [ ] 设计完善的计分公式
  - 基础分 = 判定分 × 连击倍率
  - Perfect 300分 / Great 200分 / Good 100分 / Bad 50分
  - 连击加成系数（连击越长分数越高）
  - 理论最高分 = 1,000,000（百万分制，方便比较）
- [ ] 评级系统
  - **SS** — 全 Perfect
  - **S** — 准确率 ≥ 95%
  - **A** — 准确率 ≥ 90%
  - **B** — 准确率 ≥ 80%
  - **C** — 准确率 ≥ 70%
  - **D** — 准确率 < 70%
- [ ] 准确率计算（加权平均）
- [ ] Full Combo（全连）和 All Perfect（全精准）标记

### 1.4 难度系统
- [ ] 支持单曲多难度谱面
  - 谱面目录结构扩展：`resource/charts/{id}/chart_easy.json`、`chart_normal.json`、`chart_hard.json`、`chart_expert.json`
  - `info.json` 扩展为包含各难度信息的数组
- [ ] 选歌界面支持难度切换选择
- [ ] 每个难度独立的成绩记录

### 1.5 本地数据持久化
- [ ] 本地成绩保存系统（JSON 或 SQLite）
  - 每首曲目每个难度的最佳成绩、评级、最高连击
  - 游玩次数统计
  - 首次通关标记
- [ ] 本地排行榜（每首曲目前 10 名成绩）
- [ ] 玩家配置文件保存（设置、键位、延迟等自动保存）

---

## Phase 2 — 编辑器重建与设置系统 (v0.2 Alpha 续)

> **目标：** 让谱面编辑器真正可用，让玩家可以自定义体验

### 2.1 编辑器核心修复与重建
- [ ] 完整排查 `seditor.h` (2225行) 和 `seditor_ui.h` (673行) 中的所有问题
- [ ] 音符放置/修改/删除功能修复
- [ ] 音乐加载与播放功能修复
- [ ] 谱面保存/加载功能修复
- [ ] 撤销/重做系统测试与修复

### 2.2 编辑器增强功能
- [ ] **变速 (SV - Scroll Velocity) 支持**
  - 在时间轴上设置速度变化点
  - 可视化速度曲线显示
  - 速度变化在游戏中的实际实现
- [ ] **BPM 变化支持**
  - 多 BPM 段落设置
  - 自动节拍线随 BPM 变化调整
- [ ] 鼠标端音符（circle/slider）的可视化编辑
- [ ] 谱面预览播放功能（在编辑器内直接预览游玩效果）
- [ ] 谱面难度自动计算算法

### 2.3 设置系统
- [ ] **延迟校准界面** — 提供交互式校准流程（听节拍按键，自动计算偏移）
- [ ] **键位绑定** — 自定义 4K 键位（默认 A/S/D/F，可改为 D/F/J/K 等）
- [ ] **音量分离设置** — 音乐音量、音效音量、全局音量独立调节
- [ ] **流速调节** — 下落速度可调（不影响判定，仅影响视觉）
- [ ] **显示设置** — 分辨率选择、全屏/窗口切换、帧率上限设置
- [ ] 所有设置自动保存到本地配置文件

---

## Phase 3 — 视觉与音频升级 (v0.3 Beta)

> **目标：** 打造"樱花"核心视觉体验，提升整体品质感

### 3.1 樱花主题视觉强化
- [ ] **樱花粒子系统** — 全局飘落的樱花花瓣粒子（受风力影响、有旋转和大小变化）
- [ ] **樱花主题 UI** — 按钮、面板、边框等融入樱花纹样元素
- [ ] **场景背景** — 樱花树、花瓣、春日色调的背景画面
- [ ] **季节变化** — 根据真实季节或可手动切换不同季节主题（春樱/夏绿/秋红/冬雪）
- [ ] **日系动漫风格美术素材**
  - 主菜单角色立绘
  - 音符皮肤（樱花花瓣型音符、水滴型音符等）
  - UI 图标和装饰素材

### 3.2 背景视频/动画支持
- [ ] 支持谱面自定义背景图片（已有基础支持）
- [ ] 支持谱面背景视频播放（需引入视频解码库或预渲染帧序列）
- [ ] 动态背景效果（根据音乐节奏变化的背景动画）

### 3.3 音频系统升级
- [ ] **多格式支持** — 除 WAV 外增加 MP3、OGG、FLAC 格式支持（SDL_mixer 已有基础能力）
- [ ] **丰富音效** — Hit 音效（不同判定不同音效）、Miss 音效、连击里程碑音效、按钮音效、场景切换音效
- [ ] **音频同步优化** — 精确的音频-画面同步机制，解决延迟飘移问题
- [ ] **音量设置界面** — 在设置中可调节各类音量，实时预览
- [ ] **音乐可视化** — FFT 频谱分析，背景随音乐节奏律动

### 3.4 专业美术素材
- [ ] 设计游戏 Logo 和图标
- [ ] 主菜单界面完整设计稿
- [ ] 选歌界面卡片设计
- [ ] 游戏内 HUD 设计
- [ ] 结算界面设计
- [ ] 编辑器界面设计

---

## Phase 4 — 内容制作与玩家体验 (v0.5 Early Access)

> **目标：** 充实游戏内容，提供完整的玩家体验链路

### 4.1 官方谱面库
- [ ] 使用自己创作的原创音乐制作 5-10 首官方谱面
- [ ] 每首歌至少提供 2 个难度（Normal + Hard 或以上）
- [ ] 涵盖不同 BPM 和风格的曲目，展示游戏玩法的多样性
- [ ] 包含一首教学引导谱面

### 4.2 新手教程系统
- [ ] **交互式教程** — 引导玩家了解基本操作
  - 第一课：键盘 4K 轨道基础（Tap 音符）
  - 第二课：Hold 长押音符
  - 第三课：鼠标端圆形音符
  - 第四课：双端配合（左键盘+右鼠标同时操作）
- [ ] 首次启动自动触发教程
- [ ] 教程可从设置中重新进入

### 4.3 玩家成长系统
- [ ] **经验值与等级** — 每次游玩获得经验，经验累积升级
- [ ] **成就系统**
  - 初次通关成就
  - Full Combo 成就
  - All Perfect 成就
  - 累计游玩曲目数成就
  - 累计总分成就
  - 各评级收集成就（全S、全A等）
- [ ] **个人主页/统计**
  - 总游玩次数、总游玩时长
  - 平均准确率、平均评级
  - 最擅长的难度区间
  - 成就展示

### 4.4 游戏回放功能
- [ ] 记录游玩过程的按键输入序列
- [ ] 支持回放观看（可暂停、快进）
- [ ] 回放文件导出/分享

### 4.5 数据管理
- [ ] 存档系统（自动保存 + 手动备份）
- [ ] 数据导出/导入（迁移设备时使用）
- [ ] 谱面导入/导出（打包的谱面文件格式 `.sakura`）

---

## Phase 5 — 在线社区功能 (v0.5 → v1.0)

> **目标：** 建立玩家社区，实现内容共享和竞争

### 5.1 后端服务搭建
- [ ] 使用 REST API 架构搭建后端服务
- [ ] 用户注册/登录系统（用户名+密码，可选邮箱验证）
- [ ] API 设计
  - `/auth` — 认证相关
  - `/users` — 用户信息、统计
  - `/charts` — 谱面上传/下载/搜索
  - `/scores` — 成绩上传/排行榜查询
  - `/achievements` — 成就同步

### 5.2 用户账户系统
- [ ] 游戏内注册/登录界面
- [ ] 个人资料（头像、昵称、签名）
- [ ] 云端数据同步（成绩、设置、成就）
- [ ] 离线模式支持（无网络时仍可正常游玩，上线后自动同步）

### 5.3 在线谱面市场
- [ ] 谱面上传功能（打包音乐+谱面+背景上传至服务器）
- [ ] 谱面浏览/搜索/筛选（按歌名、作者、难度、评分等）
- [ ] 谱面下载与自动安装
- [ ] 谱面评分/评论系统
- [ ] 热门谱面排行榜

### 5.4 在线排行榜
- [ ] 每首曲目每个难度的全球排行榜
- [ ] 个人成绩记录上传
- [ ] 好友排行对比
- [ ] 赛季/周期性排名重置（可选）

---

## Phase 6 — 架构优化与工程化 (持续进行)

> **目标：** 代码质量、构建流程、可维护性

### 6.1 代码架构重构
- [ ] **头文件拆分** — 当前头文件过大（`sscenes.h` 1604行、`seditor.h` 2225行），需要拆分为更小的模块
  - `sscenes.h` → `sscene_manager.h` + `sscene_index.h` + `sscene_select.h` + `sscene_game.h` + `sscene_settings.h` + ...
  - `seditor.h` → `seditor_core.h` + `seditor_io.h` + `seditor_render.h` + `seditor_events.h` + ...
- [ ] **头文件与源文件分离** (.h 声明 + .cpp 实现)，减少编译时间
- [ ] **全局变量治理** — 减少全局状态，使用更好的状态管理模式
- [ ] **统一的事件系统** — 替代当前各场景独立的事件循环
- [ ] **资源管理器重构** — 引入引用计数或智能指针管理 SDL 资源

### 6.2 构建与发布自动化
- [ ] **CI/CD 流水线** — GitHub Actions 自动构建
  - 推送/PR 时自动编译检查
  - Release tag 自动构建产物
- [ ] **安装包打包**
  - 便携版 (Portable) — 单文件夹直接运行
  - 安装包版 (Installer) — NSIS 或 Inno Setup
- [ ] **自动更新系统** — 游戏内检测新版本并提示/下载更新

### 6.3 调试与测试
- [ ] 游戏内调试信息叠加层（FPS、延迟、内存占用、音频缓冲等）
- [ ] 日志系统完善（分级别日志、日志文件轮转）
- [ ] 基础单元测试（计分公式、判定逻辑等核心算法测试）

---

## 里程碑时间线（参考）

| 版本 | 里程碑 | 主要内容 |
|------|--------|----------|
| **v0.1 Demo** | Phase 0 完成 | Bug 修复，基础可玩 |
| **v0.2 Alpha** | Phase 1 + 2 完成 | 核心玩法完善，编辑器重建，设置系统 |
| **v0.3 Beta** | Phase 3 完成 | 樱花视觉主题，音频升级，美术素材 |
| **v0.5 EA** | Phase 4 + 5 前半完成 | 官方内容，教程，账户系统 |
| **v1.0** | 全部 Phase 完成 | 完整的在线社区，谱面市场，排行榜 |

> 注：此时间线为参考规划，实际进度根据个人开发精力灵活调整。

---

## 技术栈参考

| 组件 | 技术 |
|------|------|
| 游戏引擎 | SDL2 + SDL_image + SDL_ttf + SDL_mixer |
| 编程语言 | C++ |
| 编译器 | MinGW-w64 (g++) |
| JSON 处理 | nlohmann/json |
| 字体渲染 | FreeType (通过 SDL_ttf) |
| 图片加载 | libpng (通过 SDL_image) |
| 音频解码 | Vorbis, WavPack (通过 SDL_mixer) |
| 构建系统 | VS Code Tasks (计划迁移至 CI/CD) |
| 后端 (计划) | REST API 服务 |
| 数据存储 | JSON 文件 (计划引入 SQLite) |

---

## 非功能性需求

- **性能目标：** 60 FPS 稳定运行，音频延迟 < 10ms
- **安装体积：** 基础安装 < 100MB（不含谱面库）
- **启动时间：** 冷启动 < 3 秒
- **兼容性：** Windows 10 / 11
- **可访问性：** 支持自定义键位、延迟校准、流速调节
